package APIServer;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Files;
import java.nio.file.NoSuchFileException;
import java.util.UUID;
import org.restlet.Request;
import org.restlet.data.Form;
import org.restlet.data.MediaType;
import org.restlet.representation.FileRepresentation;
import org.restlet.resource.Get;
import org.restlet.resource.ServerResource;

/**
 * Return wave files generated by calling festival in Terminal.
 * We put all the wave files into folder GeneratedWave
 * the file will be deleted after having been sent to the client
 */

public class Text2Wave extends ServerResource{
	String txt = "";
	String errorWave = "/Users/jinchen/Desktop/festival/GeneratedWave/Error.wav";
	
	@Get
    public FileRepresentation getResource() {
		FileRepresentation result = null;
		Request request =getRequest();
		Form form = request.getResourceRef().getQueryAsForm();
		txt = form.getValues("txt");	
		result = Process(txt);	
		return result;
    }

	private FileRepresentation Process(String txt){		
		FileRepresentation result = new FileRepresentation(errorWave,MediaType.AUDIO_WAV);
		String waveFilePath = "";
		String txtFile = GenerateTxtFile(txt);		
		waveFilePath = "/Users/jinchen/Desktop/festival/GeneratedWave/" + GenerateUid() + ".wav";
		String command = "/Users/jinchen/Desktop/festival/festival/bin/text2wave " + txtFile + " -o "  + waveFilePath;
		if(ExcuteCommand(command))
		{
			result = new FileRepresentation(waveFilePath,MediaType.AUDIO_WAV);			
		}
		return result;
	}
	
	private String GenerateUid()
	{
		return UUID.randomUUID().toString();
	}
	
	private String GenerateTxtFile(String txt)
	{
		String fileName = "";
		String command = "";
		String uniqueID = GenerateUid();
		fileName = "/Users/jinchen/Desktop/festival/GeneratedWave/" + uniqueID + ".txt";
		command = "echo " + "'" + txt + "'" + " > " + fileName;
		String[] commandLine = {"sh", "-c", command};
		if(ExcuteCommand(commandLine))
		{
			return fileName;
		}
		else 
		{
			return "";
		}
	}
	
	private boolean ExcuteCommand(String[] command) 
	{
		boolean result = false;
		Process p;
		try {
			p = Runtime.getRuntime().exec(command);
			p.waitFor();
			result = true;
		} catch (Exception e) {
			e.printStackTrace();
		}		
		return result;
	}
	
	private boolean ExcuteCommand(String command) 
	{
		boolean result = false;
		Process p;
		try {
			p = Runtime.getRuntime().exec(command);
			p.waitFor();
			result = true;
		} catch (Exception e) {
			e.printStackTrace();
		}		
		return result;
	}
}
